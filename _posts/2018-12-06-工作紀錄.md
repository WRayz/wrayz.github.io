---
layout: post
title:  "工作紀錄：500錯誤、實體 Key 和 ORM 有關係"
date:   2018-12-07 12:42:05 +0800
categories: jekyll update
---
## 前言
這是份工作紀錄，之後碰到印象深刻的就盡量紀錄下來吧。
這次碰到兩個處理很久
1. 5xx

2. 用 Oliver 的 SourceHelper，從資料庫撈出來的多筆資料結果拋到前端變成一筆。


### 5xx 伺服器錯誤
[維基 - 5xx 伺服器錯誤](https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81#5xx%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%94%99%E8%AF%AF)
500 Internal Server Error
通用錯誤訊息，伺服器遇到了一個未曾預料的狀況，導致了它無法完成對請求的處理。沒有給出具體錯誤資訊。

**碰到情境：**工作上在測試重構的 EF 功能是否可以順利叫用另一個 php api
結果：500 Internal Server Error

**偵錯盲點：**不知道具體錯誤資訊。
我判斷方向一直繞在請求的 code 是否錯誤，懷疑 EF 程式是不是寫錯、打包的 payload 是否有錯、懷疑 api 接收 payload 是不是跟之前不同就會得到 500...結果都不是這些問題，方向完全錯誤。

**學到的方向：** EF 叫 api 其實有發出請求，只是回應收到 500，這一種程式呼叫 api 流程，如果 api 沒有處理錯誤訊息並拋出（一般也沒有），那 C# 拋出的堆疊就只是告知說錯誤是來自 http 請求的那段程式，當下只要確定好 500 不是由程式拋錯，是請求 api 的結果，那接下來就是專注在 php api 的內部程式即可，打開 develop 開始偵錯 php 程式。

**偵錯結果：**

- php api 收到資料後，用該份資料的內容來進資料庫執行新增，結果 sql 拋出資料溢位，因為 varchar 資料不能裝到 int，除非手動轉型（不要以為會像弱型別一樣"方便")。
- 雖然傳送的資料看起來是數字（2018120700001），但打包在 JSON 傳遞時，還是有雙引號 "" 裝起來，就不是數字啦，不能新增到 int 的型別上（這不是 javascript）。



---

### 實體的 key 反應 ORM 結果

情境：
資料庫撈出的資料有

| GROUP_SN | DEVICE_SN | TARGET_NAME |
| -------- | --------- | ----------- |
| 001      | 2018001   | AA          |
| 001      | 2018002   | BB          |

前端顯示
```json
[
    {
        "GROUP_SN": "001",
        "DEVICE_SN": "2018001",
        "TARGET_NAME": "AA"
    }
]
```

**Why?**

明明資料是多筆，出來卻只有一筆，剛開始完全沒想到是實體的 Key 設計問題...完全摸不著頭緒...
因為實體的 Entity config 只有設定 GROUP_SN 是 key，結果 ORM 會依照 Key 群組化然後回傳清單，導致結果只有一筆。

**反思：**

不論是什麼樣的實體，設計時都要考慮到「Key 就是代表資料的唯一性」，不可以隨意。
